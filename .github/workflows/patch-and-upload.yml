name: Build and Upload Patched Yandex Music ASAR

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  build-asar:
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Download latest.yml
        run: Invoke-WebRequest -Uri "https://music-desktop-application.s3.yandex.net/stable/latest.yml" -OutFile "latest.yml"
        shell: powershell

      - name: Parse latest.yml to get EXE filename
        id: parse-yml
        run: |
          $yml = Get-Content latest.yml | Out-String
          $match = [regex]::Match($yml, 'url:\s*(.+\.exe)')
          if (-not $match.Success) { throw "EXE URL not found in latest.yml" }
          $exeName = $match.Groups[1].Value.Trim()
          echo "exe_name=$exeName" >> $env:GITHUB_OUTPUT
        shell: powershell

      - name: Download EXE file
        run: |
          $exeName = "${{ steps.parse-yml.outputs.exe_name }}"
          $url = "https://music-desktop-application.s3.yandex.net/stable/$exeName"
          Invoke-WebRequest -Uri $url -OutFile $exeName
        shell: powershell

      - name: Extract EXE with 7-Zip
        run: 7z x "${{ steps.parse-yml.outputs.exe_name }}" -oYandexMusicExtracted -y
        shell: powershell

      - name: Extract app-64.7z
        run: 7z x 'YandexMusicExtracted\$PLUGINSDIR\app-64.7z' -oApp64Extracted -y
        shell: powershell

      # Шаг 0: Создаем фиктивный app.asar для обхода проверки версии
      - name: Create dummy Yandex Music installation
        run: |
          # Создаем директорию где Yandex Music должен быть установлен
          $ymPath = "C:\Users\runneradmin\AppData\Local\Programs\YandexMusic\resources"
          New-Item -ItemType Directory -Force -Path $ymPath
          
          # Копируем оригинальный app.asar в этот путь
          Copy-Item -Path "App64Extracted\resources\app.asar" -Destination "$ymPath\app.asar" -Force
          echo "Created dummy Yandex Music installation at $ymPath\app.asar"
        shell: powershell

      # Шаг 1: Создаем оригинальный пропатченный app.asar
      - name: Build patched app.asar (original)
        run: |
          $asarPath = "${{ github.workspace }}\App64Extracted\resources\app.asar"
          node toolset.js extract --src="$asarPath" --withoutPure --extractType="customAsar"
          node toolset.js build --lastExtracted
        shell: powershell

      - name: Copy built app.asar to staging directory
        run: |
          New-Item -ItemType Directory -Force -Path "staging"
          Copy-Item -Path "builds\patched\app.asar" -Destination "staging\app.asar" -Force
        shell: powershell

      # Шаг 2: Создаем app.asar с devtools
      - name: Create app.asar with devtools
        run: |
          $asarPath = "${{ github.workspace }}\App64Extracted\resources\app.asar"
          node toolset.js extract -bp --withoutPure --noNativeModules --extractType="customAsar" --src="$asarPath"
          Move-Item -Path "builds\patched\app.asar" -Destination "staging\appDevTools.asar" -Force
        shell: powershell

      # Шаг 3: Сжимаем devtools версию
      - name: Prepare devtools version for upload
        run: |
          cd staging
          7z a -tgzip "appDevTools.asar.gz" "appDevTools.asar"
        shell: powershell

      # Шаг 4: Определяем тег релиза
      - name: Determine release tag
        id: release-tag
        run: |
          if ($env:GITHUB_EVENT_NAME -eq 'release') {
            $tag = "${{ github.event.release.tag_name }}"
          } else {
            $latestRelease = Invoke-RestMethod `
              -Uri "https://api.github.com/repos/${{ github.repository }}/releases/latest"
            $tag = $latestRelease.tag_name
          }
          echo "tag_name=$tag" >> $env:GITHUB_OUTPUT
        shell: powershell

      # Шаг 5: Загружаем файлы в релиз
      - name: Upload files to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release-tag.outputs.tag_name }}
          files: |
            staging/app.asar
            staging/appDevTools.asar
            staging/appDevTools.asar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

      # Шаг 6: Загружаем app.asar для сжатия на Ubuntu
      - name: Upload app.asar for compression
        uses: actions/upload-artifact@v4
        with:
          name: asar-files
          path: staging/app.asar
          retention-days: 1

  compress-asar:
    runs-on: ubuntu-latest
    needs: build-asar
    if: always()

    steps:
      - name: Download asar artifact
        uses: actions/download-artifact@v4
        with:
          name: asar-files
          path: .

      - name: Install compression tools
        run: sudo apt-get update && sudo apt-get install -y gzip zstd

      - name: Compress app.asar with gzip and zstd
        run: |
          gzip -k -9 app.asar
          zstd -11 -k app.asar

      - name: Determine release tag
        id: get_release
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "TAG=${{ github.event.release.tag_name }}" >> $GITHUB_ENV
          else
            LATEST_TAG=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r '.tag_name')
            echo "TAG=$LATEST_TAG" >> $GITHUB_ENV
          fi

      - name: Upload compressed files to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          files: |
            app.asar.gz
            app.asar.zst
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}