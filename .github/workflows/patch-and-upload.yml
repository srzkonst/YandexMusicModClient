name: Patch and Upload Yandex Music app.asar

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  patch-asar:
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # Повышаем для Vite

      - name: Install dependencies
        run: npm install

      - name: Download latest.yml
        run: Invoke-WebRequest -Uri "https://music-desktop-application.s3.yandex.net/stable/latest.yml" -OutFile "latest.yml"
        shell: powershell

      - name: Parse latest.yml to get EXE filename
        id: parse-yml
        run: |
          $yml = Get-Content latest.yml | Out-String
          $match = [regex]::Match($yml, 'url:\s*(.+\.exe)')
          if (-not $match.Success) { throw "EXE URL not found in latest.yml" }
          $exeName = $match.Groups[1].Value.Trim()
          echo "exe_name=$exeName" >> $env:GITHUB_OUTPUT
        shell: powershell

      - name: Download EXE file
        run: |
          $exeName = "${{ steps.parse-yml.outputs.exe_name }}"
          $url = "https://music-desktop-application.s3.yandex.net/stable/$exeName"
          Invoke-WebRequest -Uri $url -OutFile $exeName
        shell: powershell

      - name: Extract EXE with 7-Zip
        run: 7z x "${{ steps.parse-yml.outputs.exe_name }}" -oYandexMusicExtracted -y
        shell: powershell

      - name: Extract app-64.7z
        run: 7z x 'YandexMusicExtracted\$PLUGINSDIR\app-64.7z' -oApp64Extracted -y
        shell: powershell

      # ======== СОХРАНЕНИЕ ОРИГИНАЛЬНЫХ ФАЙЛОВ ========
      - name: Save original files
        run: |
          New-Item -ItemType Directory -Force -Path "builds\patched"
          
          # Копируем оригинальный app.asar
          Copy-Item -Path "${{ github.workspace }}\App64Extracted\resources\app.asar" -Destination "builds\patched\app.asar"
          
          # Создаём app.asar.unpacked.zip
          $unpackedPath = "${{ github.workspace }}\App64Extracted\resources\app.asar.unpacked"
          if (Test-Path $unpackedPath) {
            7z a -tzip "builds\patched\app.asar.unpacked.zip" "$unpackedPath\*"
          }
        shell: powershell

      # ======== ВЕРСИЯ 1: ПОЛНЫЙ БИЛД (без DevTools) ========
      - name: Extract for full build
        run: |
          $asarPath = "${{ github.workspace }}\App64Extracted\resources\app.asar"
          # Извлекаем БЕЗ флага -p (без патчей)
          node toolset.js extract --withoutPure --noNativeModules --extractType="customAsar" --src="$asarPath"
        shell: powershell

      - name: Build full version (no DevTools)
        run: |
          # Копируем извлечённый билд для сохранения
          Copy-Item -Path "extracted\*" -Destination "extracted_full" -Recurse -Force
          
          # Собираем БЕЗ патчей
          node toolset.js build --lastExtracted --dest="builds\patched\app_full.asar"
        shell: powershell

      # ======== ВЕРСИЯ 2: DEVTOOLS БИЛД ========
      - name: Extract for DevTools build
        run: |
          $asarPath = "${{ github.workspace }}\App64Extracted\resources\app.asar"
          # Извлекаем снова для DevTools версии
          node toolset.js extract --withoutPure --noNativeModules --extractType="customAsar" --src="$asarPath"
        shell: powershell

      - name: Patch for DevTools
        run: |
          # Применяем патчи DevTools
          node toolset.js patch
        shell: powershell

      - name: Build DevTools version
        run: |
          # Собираем с патчами
          node toolset.js build --lastExtracted --dest="builds\patched\app_devtools.asar"
        shell: powershell

      # ======== СЖАТИЕ ФАЙЛОВ ========
      - name: Install zstd
        run: choco install zstandard -y
        shell: powershell

      - name: Gzip all asar files
        run: |
          # Оригинальный
          7z a -tgzip "builds\patched\app.asar.gz" "builds\patched\app.asar"
          # Полная версия (без DevTools)
          7z a -tgzip "builds\patched\app_full.asar.gz" "builds\patched\app_full.asar"
          # DevTools версия
          7z a -tgzip "builds\patched\app_devtools.asar.gz" "builds\patched\app_devtools.asar"
        shell: powershell

      - name: Create zstd compressed files
        run: |
          # Оригинальный
          zstd -11 "builds\patched\app.asar" -o "builds\patched\app.asar.zst"
          # Полная версия
          zstd -11 "builds\patched\app_full.asar" -o "builds\patched\app_full.asar.zst"
        shell: powershell

      - name: Determine release tag
        id: release-tag
        run: |
          if ($env:GITHUB_EVENT_NAME -eq 'release') {
            $tag = "${{ github.event.release.tag_name }}"
          } else {
            $latestRelease = Invoke-RestMethod `
              -Uri "https://api.github.com/repos/${{ github.repository }}/releases/latest"
            $tag = $latestRelease.tag_name
          }
          echo "tag_name=$tag" >> $env:GITHUB_OUTPUT
        shell: powershell

      # ======== ЗАГРУЗКА ВСЕХ ФАЙЛОВ ========
      - name: Upload ALL assets to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release-tag.outputs.tag_name }}
          files: |
            # Оригинальные файлы
            builds/patched/app.asar
            builds/patched/app.asar.gz
            builds/patched/app.asar.zst
            builds/patched/app.asar.unpacked.zip
            
            # Полная версия (без DevTools)
            builds/patched/app_full.asar
            builds/patched/app_full.asar.gz
            builds/patched/app_full.asar.zst
            
            # DevTools версия
            builds/patched/app_devtools.asar
            builds/patched/app_devtools.asar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}